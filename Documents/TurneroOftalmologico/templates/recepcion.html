<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Turnos - Recepci√≥n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-section, .turnos-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            width: auto;
        }
        button:hover {
            background-color: #0056b3;
        }
        .turno-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .turno-header {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .turno-info {
            color: #666;
            margin: 5px 0;
        }
        .hidden {
            display: none;
        }
        .section-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .turno-acciones {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            text-align: right;
        }

        .turno-acciones button {
            padding: 5px 10px;
            margin-left: 5px;
            font-size: 12px;
            background-color: #6c757d;
        }

        .turno-acciones button:hover {
            background-color: #545b62;
        }

        .turno-acciones button:first-child {
            background-color: #17a2b8;
        }

        .turno-acciones button:first-child:hover {
            background-color: #138496;
        }
        /* Estilos para el modal */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    position: relative;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }

    .close:hover {
        color: black;
    }

    .form-actions {
        margin-top: 20px;
        text-align: right;
    }

    .form-actions button {
        margin-left: 10px;
    }

    .form-actions button[type="button"] {
        background-color: #6c757d;
    }

    .form-actions button[type="button"]:hover {
        background-color: #545b62;
    }

    .form-actions button[type="submit"] {
        background-color: #28a745;
    }

    .form-actions button[type="submit"]:hover {
        background-color: #218838;
    }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• Sistema de Turnos - Recepci√≥n</h1>
        
        <!-- Formulario para crear turnos -->
        <div class="form-section">
            <h2 class="section-title">Crear Nuevo Turno</h2>
            <form id="formTurno">
                <div class="form-group">
                    <label for="paciente_nombre">Nombre del Paciente:</label>
                    <input type="text" id="paciente_nombre" required>
                </div>
                
                <div class="form-group">
                    <label for="paciente_edad">Edad:</label>
                    <input type="number" id="paciente_edad" required>
                </div>
                
                <div class="form-group">
                    <label for="tipo">Tipo de Turno:</label>
                    <select id="tipo" required onchange="mostrarOpcionesEspecificas()">
                        <option value="">Seleccionar tipo</option>
                        <option value="CITA">Con Cita</option>
                        <option value="SIN_CITA">Sin Cita</option>
                    </select>
                </div>
                
                <!-- Opciones espec√≠ficas para pacientes con cita -->
                <div class="form-group hidden" id="opcionesCita">
                    <label for="estacion_inicial">Destino Inicial:</label>
                    <select id="estacion_inicial" onchange="mostrarSelectorDoctor()">
                        <option value="">Seleccionar destino</option>
                        <option value="3">Toma de Calculos</option>
                        <option value="4">Consulta Medica</option>
                        <option value="5">Farmacia</option>
                        <option value="6">Asesoria Visual</option>
                        <option value="7">Estudios Especiales</option>
                    </select>
                </div>
                
                <!-- Selector de Doctores (solo para Consulta M√©dica) -->
                <div class="form-group hidden" id="selectorDoctor">
                    <label for="doctor_asignado">Seleccionar Doctor:</label>
                    <select id="doctor_asignado">
                        <option value="">Seleccionar doctor</option>
                        <!-- Los doctores se cargar√°n din√°micamente -->
                    </select>
                </div>
                
                <!-- Para pacientes sin cita, siempre van a Trabajo Social -->
                <div class="form-group hidden" id="opcionesSinCita">
                    <label>Destino Inicial:</label>
                    <input type="text" value="Trabajo Social" disabled style="background-color: #e9ecef;">
                    <input type="hidden" id="estacion_sin_cita" value="2">
                </div>
                
                <button type="submit">Generar Turno</button>
            </form>
        </div>
        <!-- Buscador de turnos -->
        <div class="busqueda-section">
            <h3>üîç Buscar Turno</h3>
            <input type="text" id="buscarTurno" placeholder="Buscar por n√∫mero o nombre...">
            <button onclick="buscarTurno()">Buscar</button>
        </div>

        <!-- Lista de turnos activos -->
        <div class="turnos-section">
            <h2 class="section-title">Turnos Activos</h2>
            <div id="listaTurnos">
                <p>Cargando turnos...</p>
            </div>
        </div>
    </div>
    <div id="modalEditar" class="modal hidden">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>‚úèÔ∏è Editar Turno</h2>
        <form id="formEditarTurno">
            <input type="hidden" id="editar_turno_id">
            
            <div class="form-group">
                <label for="editar_paciente_nombre">Nombre del Paciente:</label>
                <input type="text" id="editar_paciente_nombre" required>
            </div>
            
            <div class="form-group">
                <label for="editar_paciente_edad">Edad:</label>
                <input type="number" id="editar_paciente_edad" required>
            </div>
            
            <div class="form-group">
                <label for="editar_tipo">Tipo de Turno:</label>
                <select id="editar_tipo" required>
                    <option value="CITA">Con Cita</option>
                    <option value="SIN_CITA">Sin Cita</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editar_estacion_actual">Estaci√≥n Actual:</label>
                <select id="editar_estacion_actual" required>
                    <option value="2">Trabajo Social</option>
                    <option value="3">Toma de C√°lculos</option>
                    <option value="4">Consulta M√©dica</option>
                    <option value="5">Farmacia</option>
                    <option value="6">Asesor√≠a Visual</option>
                    <option value="7">Estudios Especiales</option>
                </select>
            </div>
            
            <div class="form-group" id="editar_selector_doctor_container">
                <label for="editar_doctor_asignado">Doctor Asignado:</label>
                <select id="editar_doctor_asignado">
                    <option value="">Sin doctor asignado</option>
                    <!-- Se llenar√° din√°micamente -->
                </select>
            </div>
            
            <div class="form-actions">
                <button type="button" onclick="cerrarModal()">Cancelar</button>
                <button type="submit">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

    <script>
        // Cargar turnos y doctores al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarTurnos();
            cargarDoctores();
            mostrarOpcionesEspecificas();
        });

        // Cargar lista de doctores activos
        function cargarDoctores() {
            fetch('/api/doctores')
                .then(response => response.json())
                .then(doctores => {
                    const selector = document.getElementById('doctor_asignado');
                    selector.innerHTML = '<option value="">Seleccionar doctor</option>';
                    
                    doctores.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.id;
                        option.textContent = `${doctor.nombre} - ${doctor.especialidad}`;
                        selector.appendChild(option);
                    });
                });
        }

        // Mostrar/ocultar opciones seg√∫n tipo de turno
        function mostrarOpcionesEspecificas() {
            const tipo = document.getElementById('tipo').value;
            const opcionesCita = document.getElementById('opcionesCita');
            const opcionesSinCita = document.getElementById('opcionesSinCita');
            const selectorDoctor = document.getElementById('selectorDoctor');
            
            // Ocultar todo primero
            opcionesCita.classList.add('hidden');
            opcionesSinCita.classList.add('hidden');
            selectorDoctor.classList.add('hidden');
            
            if (tipo === 'CITA') {
                opcionesCita.classList.remove('hidden');
            } else if (tipo === 'SIN_CITA') {
                opcionesSinCita.classList.remove('hidden');
            }
        }

        // Mostrar selector de doctores solo cuando se selecciona Consulta M√©dica
        function mostrarSelectorDoctor() {
            const estacionSeleccionada = document.getElementById('estacion_inicial').value;
            const selectorDoctor = document.getElementById('selectorDoctor');
            
            if (estacionSeleccionada === '4') { // 6 = Consulta M√©dica
                selectorDoctor.classList.remove('hidden');
            } else {
                selectorDoctor.classList.add('hidden');
                document.getElementById('doctor_asignado').value = '';
            }
        }

        // Crear nuevo turno
        document.getElementById('formTurno').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const tipo = document.getElementById('tipo').value;
            let estacion_inicial, doctor_asignado;
            
            if (tipo === 'CITA') {
                estacion_inicial = document.getElementById('estacion_inicial').value;
                doctor_asignado = document.getElementById('doctor_asignado').value || null;
            } else {
                estacion_inicial = document.getElementById('estacion_sin_cita').value;
                doctor_asignado = null;
            }
            
            // Validaciones
            if (!estacion_inicial) {
                alert('Por favor selecciona un destino inicial');
                return;
            }
            
            const datos = {
                paciente_nombre: document.getElementById('paciente_nombre').value,
                paciente_edad: document.getElementById('paciente_edad').value,
                tipo: tipo,
                estacion_inicial: parseInt(estacion_inicial),
                doctor_asignado: doctor_asignado ? parseInt(doctor_asignado) : null
            };

            fetch('/api/turnos/nuevo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(datos)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ Turno generado: ${data.numero_turno}`);
                    document.getElementById('formTurno').reset();
                    mostrarOpcionesEspecificas();
                    cargarTurnos();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al crear el turno');
            });
        });

        // Funci√≥n para cargar turnos
        function cargarTurnos() {
    fetch('/api/turnos')
        .then(response => response.json())
        .then(turnos => {
            console.log("DEBUG - Datos recibidos:", turnos); // ‚Üê Para verificar en consola
            
            const lista = document.getElementById('listaTurnos');
            
            if (turnos.length === 0) {
                lista.innerHTML = '<p>No hay turnos activos</p>';
                return;
            }

            // CUANDO S√ç HAY TURNOS - esto estaba faltando
            lista.innerHTML = turnos.map(turno => `
                <div class="turno-card">
                    <div class="turno-header">Turno ${turno.numero}</div>
                    <div class="turno-info">Paciente: ${turno.paciente_nombre}</div>
                    <div class="turno-info">Edad: ${turno.paciente_edad} a√±os</div>
                    <div class="turno-info">Tipo: ${turno.tipo === 'CITA' ? 'Con Cita' : 'Sin Cita'}</div>
                    <div class="turno-info">Estaci√≥n: ${turno.estacion_actual_nombre || 'Recepci√≥n'}</div>
                    <div class="turno-info">Estado: ${turno.estado}</div>
                    ${turno.doctor_nombre ? `<div class="turno-info">Doctor: ${turno.doctor_nombre}</div>` : ''}

                    <!-- BOTONES CORREGIDOS -->
                    <div class="turno-acciones">
                        <button onclick="editarTurno(${turno.id})">‚úèÔ∏è Editar</button>
                        <button onclick="cancelarTurno(${turno.id})">‚ùå Cancelar</button>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error cargando turnos:', error);
            document.getElementById('listaTurnos').innerHTML = '<p>Error al cargar los turnos</p>';
        });
}

        // Actualizar cada 10 segundos
        setInterval(cargarTurnos, 10000);
        function editarTurno(turnoId) {
            fetch('/api/turnos')
                .then(response => response.json())
                .then(turnos => {
                    const turno = turnos.find(t => t.id === turnoId);
                    if (!turno) {
                        alert('Turno no encontrado');
                        return;
                    }
                    
                    // Llenar el formulario con los datos actuales
                    document.getElementById('editar_turno_id').value = turno.id;
                    document.getElementById('editar_paciente_nombre').value = turno.paciente_nombre;
                    document.getElementById('editar_paciente_edad').value = turno.paciente_edad;
                    document.getElementById('editar_tipo').value = turno.tipo;
                    document.getElementById('editar_estacion_actual').value = turno.estacion_actual;
                    
                    // Cargar doctores en el selector
                    cargarDoctoresParaEdicion();
                    
                    // Mostrar/ocultar selector de doctor seg√∫n estaci√≥n
                    mostrarSelectorDoctorEdicion(turno.estacion_actual);
                    
                    // Seleccionar el doctor actual si existe
                    if (turno.doctor_asignado) {
                        document.getElementById('editar_doctor_asignado').value = turno.doctor_asignado;
                    }
                    
                    // Mostrar el modal
                    document.getElementById('modalEditar').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar datos del turno');
                });
        }

        // Funci√≥n para cargar doctores en el modal de edici√≥n
        function cargarDoctoresParaEdicion() {
            fetch('/api/doctores')
                .then(response => response.json())
                .then(doctores => {
                    const selector = document.getElementById('editar_doctor_asignado');
                    selector.innerHTML = '<option value="">Sin doctor asignado</option>';
                    
                    doctores.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.id;
                        option.textContent = `${doctor.nombre} - ${doctor.especialidad}`;
                        selector.appendChild(option);
                    });
                });
        }

        // Mostrar/ocultar selector de doctor en edici√≥n
        function mostrarSelectorDoctorEdicion(estacionId) {
            const container = document.getElementById('editar_selector_doctor_container');
            if (estacionId == 4) { // Consulta M√©dica
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                document.getElementById('editar_doctor_asignado').value = '';
            }
        }

        // Cerrar modal
        function cerrarModal() {
            document.getElementById('modalEditar').classList.add('hidden');
        }

        // Enviar formulario de edici√≥n
        document.getElementById('formEditarTurno').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const turnoId = document.getElementById('editar_turno_id').value;
            const estacionActual = document.getElementById('editar_estacion_actual').value;
            
            const datos = {
                paciente_nombre: document.getElementById('editar_paciente_nombre').value,
                paciente_edad: parseInt(document.getElementById('editar_paciente_edad').value),
                tipo: document.getElementById('editar_tipo').value,
                estacion_actual: parseInt(estacionActual),
                doctor_asignado: estacionActual == 4 ? 
                    (document.getElementById('editar_doctor_asignado').value || null) : null
            };
            
            fetch(`/api/turnos/${turnoId}/editar`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(datos)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Turno editado correctamente');
                    cerrarModal();
                    cargarTurnos();
                } else {
                    alert('Error al editar el turno');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al editar el turno');
            });
        });

        // Cerrar modal al hacer clic en la X
        document.querySelector('.close').addEventListener('click', cerrarModal);

        // Cerrar modal al hacer clic fuera del contenido
        document.getElementById('modalEditar').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });

        // Mostrar/ocultar selector de doctor cuando cambia la estaci√≥n en edici√≥n
        document.getElementById('editar_estacion_actual').addEventListener('change', function() {
            mostrarSelectorDoctorEdicion(this.value);
        });

        // Funci√≥n para cancelar turno (se mantiene igual)
        function cancelarTurno(turnoId) {
            if (confirm('¬øEst√°s seguro de que quieres cancelar este turno?')) {
                fetch(`/api/turnos/${turnoId}/cancelar`, {
                    method: 'PUT'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ Turno cancelado');
                        cargarTurnos();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cancelar el turno');
                });
            }
        }
        



    </script>
</body>
</html>